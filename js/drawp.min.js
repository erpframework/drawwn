/*
 *Copyright 2012 Dyologic LLC.
 *Author: Austin Anderson
 *Use under MIT license
 */
(function(e){var t={loaded:false,global:null,objectList:null,opts:{tools:{circle:true,arrow:true,line:true,text:true,magnify:true,freehand:true,selector:true},loadImage:true,exportImage:function(e){},zoom:true,colors:true,height:"500",width:"500",brushSize:3,brushColor:"#00AAAA"},init:function(t,n){var r=this;this.opts=e.extend(this.opts,t);this.global=n.data();this.global.options=this.opts;this.global.id=n.attr("id");this.global.currentTool=undefined;this.global.selectors=[];if(!n.html()){n.attr("class","drawwn");n.html("<canvas id='draw_"+n.attr("id")+"'></canvas>")}e("#draw_"+n.attr("id")).css({cursor:"crosshair"});e("#draw_"+n.attr("id")).css({height:r.global.options.height,width:r.global.options.width});e("#draw_"+n.attr("id")).after('<div class="drawwn_under"><div class="drawwn_other"></div></div>');e("#"+n.attr("id")).find(".drawwn_other").append("<div class='export_image'>Finished</div>").append('<div class="draw_undo">Undo</div>').append("<div class='clear_image'>Clear</div>");r.loadTools(r.global);e("#"+n.attr("id")).find(".drawwn_under").after('<div class="drawwn_settings"><div class="drawwn_slider"><input type="text" data-slider="true" value="3" data-slider-range="2,12" data-slider-step="1"><span>15%</span></div><div class="drawwn_colorpicker"></div></div>');e.getScript("inc/colorpicker/js/colorpicker.js",function(){e("#"+n.attr("id")).find(".drawwn_colorpicker").ColorPicker({onShow:function(t){e(t).fadeIn(500);return false},onHide:function(t){e(t).fadeOut(500);return false},onChange:function(t,i,s){e("#"+n.attr("id")).find(".drawwn_colorpicker").css("backgroundColor","#"+i);r.opts.brushColor="#"+i}})});e.getScript("inc/slider/js/simple-slider.min.js",function(){e("#"+n.attr("id")).find(".drawwn_slider input").bind("slider:changed",function(t,n){r.opts.brushSize=n.value;var i=~~(n.ratio*100)+"%";e(this).siblings("span").html(i)})});e("#"+r.global.id).find(".draw_undo").click(function(){r.undo(r.objectList)});e("#"+r.global.id).find(".export_image").click(function(){var t=confirm("Are you sure you are done with your changes?");if(t==true){var n=e("#"+r.global.id).find("canvas")[0].toDataURL();r.opts.exportImage(n)}});e("#"+r.global.id).find(".clear_image").click(function(){var e=confirm("Are you sure you want to remove Everything?");if(e==true){r.canvas.reset()}else{}});e.getScript("js/ocanvas.js",function(){var t=oCanvas.create({canvas:"#draw_"+r.global.id,background:r.global.options.background,fps:40,disableScrolling:true});t.width=r.global.options.width;t.height=r.global.options.height;r.canvas=t;r.loaded=true;r.canvas.bind("mousedown touchstart",function(t){var n=r.canvas;var i=n.pointer;var s=r.global.currentTool!==undefined?r.global.currentTool:"nope";var o=r.tools[s](r.canvas,t,r.opts);if(o){if(o.jquery!==undefined){}else if(o.children!==undefined){n.addChild(o)}else if(o!=="selector"){n.addChild(o.line);n.addChild(o.arrow)}else{}if(s=="drawwn_tool_line"){n.mouse.hide();o.bind("click tap",function(e){r.select(r.global,o,e,r.canvas)});n.setLoop(function(){o.end={x:i.x,y:i.y}}).start()}else if(s=="drawwn_tool_freehand"){n.setLoop(function(){var e=r.tools[s](r.canvas,t,r.opts);e.end={x:i.x,y:i.y}}).start()}else if(s=="drawwn_tool_circle"){o.bind("click tap",function(e){r.select(r.global,o,e,r.canvas)});try{n.mouse.hide();var u=o.x;var a=o.y;n.setLoop(function(){o.radius_x=n.pointer.x-o.x;o.radius_y=n.pointer.y-o.y}).start()}catch(t){}}else if(s=="drawwn_tool_arrow"){n.mouse.hide();o.arrow.bind("click tap",function(e){r.select(r.global,o.arrow,e,r.canvas)});o.line.bind("click tap",function(e){r.select(r.global,o.line,e,r.canvas)});line=o.line,arrow=o.arrow;n.setLoop(function(){line.end={x:i.x,y:i.y};arrow.x=line.end.x;arrow.y=line.end.y;arrow.rotation=Math.atan2(line.start.y-arrow.y,line.start.x-arrow.x)*(180/Math.PI)-60}).start()}else if(s=="drawwn_tool_text"){var f=i.x;var l=i.y;e(o).unbind("click").bind("click",function(){var t=e(this).siblings("input").val();var i=n.display.text({size:r.opts.brushSize+"px",text:t,origin:{x:"center",y:"top"},font:"bold "+r.opts.brushSize*12+"px"+" sans-serif",fill:r.opts.brushColor,x:f,y:l});i.bind("click tap",function(e){r.select(r.global,i,e,r.canvas)});n.addChild(i);e(o).parent().remove()})}else if(s=="drawwn_tool_selector"){}else{alert("no tool selected")}}else{alert("no tool selected")}});r.canvas.bind("mouseup touchend",function(t){r.canvas.timeline.stop();r.canvas.mouse.show();e("#draw_"+n.attr("id")).css({cursor:"crosshair"});r.objectList=r.canvas})});var i={};var s=function(t){var n=new Image;n.onload=function(){var n=this.width;var i=this.height;var s=this.height+"px";var o=this.width+"px";var u=r.canvas.display.image({x:0,y:0,orgin:{x:"center",y:"center"},image:t});r.canvas.addChild(u);var u=r.canvas.display.image({x:0,y:0,orgin:{x:"center",y:"center"},image:t});r.canvas.addChild(u);r.objectList=r.canvas;r.canvas.width=n;r.canvas.height=i;e("#"+r.global.id).find("canvas").css({width:n,height:i})};n.src=t};var o=function(e){};var u=function(e){var t;t=setInterval(function(){if(r.loaded==true){clearInterval(t);e({canvas:r.canvas,exportImage:o,loadImage:s,loaded:r.loaded})}},200)};i.waitTillReady=u;return i},select:function(e,t,n,r){if(e.currentTool=="drawwn_tool_selector"){if(t.family!==undefined){var i=t.width;var s=t.height}else if(t.radius_y==0&&t.radius_x==0){var i=t.width;var s=t.height}else if(t.type=="ellipse"){var i=t.radius_x;var s=t.radius_y}else{var i=t.radius;var s=t.radius}var o=r.display.rectangle({x:t.x-i-5,y:t.y-s-5,width:i*2+10,opacity:.3,height:s*2+10,stroke:"2px red"});if(e.selectors.length!=0){for(var u=0;u<e.selectors.length;u++){r.removeChild(e.selectors[u])}}r.addChild(o);o.bind("mousedown touchstart",function(e){o.unbind("mouseup touchend");r.setLoop(function(){t.x=r.pointer.x;t.y=r.pointer.y;o.x=t.x-i-5;o.y=t.y-s-5}).start()});r.unbind("keydown").bind("keydown",function(e){if(e.which==46){r.removeChild(o);r.removeChild(t)}});r.bind("mouseup touchend",function(){r.timeline.stop();o.unbind("mousedown touchstart")});e.selectors.push(o)}},undo:function(e){var t=this;var n=e.children[e.children.length-1];if(n===undefined){return false}else if(n.sides!==undefined&&n.sides==3){e.removeChild(e.children[e.children.length-1]);e.removeChild(e.children[e.children.length-1])}else{e.removeChild(e.children[e.children.length-1])}},loadTools:function(t){var n=this;var r=t.id,i="tools_"+r;e("#"+r).find(".drawwn_under").append("<div class='drawwn_toolset'></div>");e("#"+r).find(".drawwn_toolset").append("<div class='"+i+"'></div>");n.tools.global=n.global;for(var s in t.options.tools){if(t.options.tools[s]==true){e("."+i).append("<div class='drawwn_tool' value='drawwn_tool_"+s+"'>"+s+"</div>")}}e("#"+r).find(".drawwn_tool").bind("click",function(){e(this).parents(".drawwn").find(".drawwn_textbox").remove();if(n.global.selectors.length!=0){for(var t=0;t<n.global.selectors.length;t++){n.canvas.removeChild(n.global.selectors[t])}}if(!e(this).hasClass("drawwn_select")){e("#"+r).find(".drawwn_tool").removeClass("drawwn_select");e(this).addClass("drawwn_select");if(n.loaded){var i=e(this).attr("value");n.global.currentTool=i}else{}}else{e("#"+r).find(".drawwn_tool").removeClass("drawwn_select");n.global.currentTool=undefined}})},tools:{global:null,drawwn_tool_line:function(e,t,n){posX=e.pointer.x;posY=e.pointer.y;var r=e.display.line({start:{x:posX,y:posY},end:{x:posX,y:posY},stroke:n.brushSize+" "+n.brushColor,cap:"round"});return r},drawwn_tool_arrow:function(e,t,n){posX=e.pointer.x;posY=e.pointer.y;var r=e.display.line({start:{x:posX,y:posY},end:{x:posX,y:posY},stroke:n.brushSize+" "+n.brushColor,cap:"flat"});var i=e.display.polygon({sides:3,radius:n.brushSize*3+4,rotation:360,x:posX,y:posY,fill:n.brushColor});return{line:r,arrow:i}},drawwn_tool_magnify:function(e){},drawwn_tool_circle:function(e,t,n){try{posX=e.pointer.x;posY=e.pointer.y;var r=e.display.ellipse({x:posX,y:posY,stroke:n.brushSize+" "+n.brushColor});console.log(r);return r}catch(i){}},drawwn_tool_freehand:function(e,t,n){posX=e.pointer.x;posY=e.pointer.y;var r=e.display.ellipse({start:{x:posX,y:posY},end:{x:posX,y:posY},stroke:n.brushSize+" "+n.brushColor,cap:"round"});return r},drawwn_tool_text:function(t,n,r){posX=t.pointer.x;posY=t.pointer.y;var i=e("#"+this.global.id);i.append('<div class="drawwn_textbox">                                     <input type="text">                                     <button>done</button>                                     </div>');i.find(".drawwn_textbox").css({left:t.pointer.x,top:t.pointer.y});var s=e(i).find(".drawwn_textbox button");return s},drawwn_tool_selector:function(e,t,n){return"selector"},nope:function(e){return false}}};e.fn.drawwn=function(e){var n=this;var r=t.init(e,n);return r}})(jQuery)